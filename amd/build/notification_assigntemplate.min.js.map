{"version":3,"file":"notification_assigntemplate.min.js","sources":["../src/notification_assigntemplate.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n * @module   local_notificationsagent/assigntemplate\n * @copyright 2023, ISYC\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n\n    return {\n\n        init: function() {\n            var module = this;\n            var idtemplate;\n            $('#assignTemplateModal').on('show.bs.modal', function (event) {\n                var button = $(event.relatedTarget);\n                idtemplate = button.data('idtemplate');\n    \n                var modal = $(this);\n                modal.find('.modal-title > span').text($('#card-'+idtemplate+' .badge').text());\n                modal.find('.badge').text($('#card-'+idtemplate+' .badge').text());\n                modal.find('.badge').attr('class', 'mr-2 '+$('#card-'+idtemplate+' .badge').attr('class'));\n                \n                modal.find('.modal-body .name').text($('#card-'+idtemplate+' .name').text());\n\n                /* Rellenar cursos asignados */\n                $.ajax({\n                    type: \"POST\",\n                    url: '/local/notificationsagent/assignrule.php',\n                    data: {\n                        ruleid: idtemplate\n                    },\n                    success: function(data) {\n                        data['category'].forEach((categoryid) => {\n                            let category = $('#assignTemplateModal .category-listing input#checkboxcategory-' + categoryid);\n                            if (category.length) {\n                                category.prop('checked', true);\n                                $('#category-listing-content-' + categoryid + ' input[type=\"checkbox\"]').prop(\"checked\", true);\n                                $('#listitem-category-' + categoryid + ' input[type=\"checkbox\"]').prop(\"checked\", true);\n                            }\n                        });\n\n                        data['course'].forEach((courseid) => {\n                            let course = $('#assignTemplateModal .category-listing input#checkboxcourse-' + courseid);\n                            if (course.length) {\n                                course.prop('checked', true);\n                            }\n                        });\n                    },\n                    error: function(XMLHttpRequest, textStatus, errorThrown) { \n                        console.log(\"Status: \" + textStatus); \n                        console.log(errorThrown); \n                    },\n                    dataType: 'json'\n                });\n            });\n            $('#assignTemplateModal').on('hide.bs.modal', function () {\n                $('#assignTemplateModal .custom-control-input').prop('checked', false);\n            });\n            $('#assignTemplateModal .collapse').on('show.bs.collapse', function () {\n                $(this).parents('.listitem-category').removeClass('collapsed');\n            });\n            $('#assignTemplateModal .collapse').on('hide.bs.collapse', function () {\n                $(this).parents('.listitem-category').addClass('collapsed');\n            });\n\n            /* checkbox */\n            $('#assignTemplateModal #course-category-select-all').on('click', function(){\n                var checkassign = $('#assignTemplateModal .category-listing .custom-control-input');\n                checkassign.prop('checked', $(this).prop('checked'));\n            });\n            $('#assignTemplateModal .category-listing').on('change', 'input[type=checkbox]', function () {\n                var checkssubcategoriescourses = '#category-listing-content-'+$(this).attr(\"id\").replace('checkboxcategory-', '')+' .custom-control-input';\n                $('#assignTemplateModal .category-listing '+checkssubcategoriescourses).prop('checked', $(this).prop('checked'));\n            });\n\n            $('#assignTemplateModal #saveassignTemplateModal').on('click', function() {\n                var data = {};\n                data['category'] = [];\n                data['course'] = [];\n                var allCategories = [];\n\n                let mainCategories = $('#assignTemplateModal #category-listing-content-0 > li[id^=\"listitem-category-\"]').has('input[id^=\"checkboxcategory-\"]:checked');\n\n                mainCategories.each(function() {\n                    let items = $('#' + this.id + ' input[id^=\"checkboxcategory-\"]:checked').map(function() {\n                        let id = $(this).attr('id').replace('checkboxcategory-', '');\n                        let parent = $(this).data('parent').replace('#category-listing-content-', '');\n\n                        if ($.inArray(id, allCategories) === -1) {\n                            allCategories.push(id);\n                        }\n                        \n                        return {id: id, parent: parent};\n                    }).get();\n\n                    var parents = $.map(items, function(item) {\n                        return item.id;\n                    });\n\n                    $.grep(items, function(item) {\n                        if ($.inArray(item.parent, parents) === -1) {\n                            data['category'].push(item.id);\n                        }\n                    });\n                });\n\n                let courses = $('#assignTemplateModal .category-listing input[id^=\"checkboxcourse-\"]:checked').map(function() {\n                    let id = $(this).attr('id').replace('checkboxcourse-', '');\n                    let category = $(this).data('parent').replace('#category-listing-content-', '');\n                    \n                    return {id: id, category: category};\n                }).get();\n\n                if ($.isEmptyObject(data['category'])) {\n                    $.each(courses, function(index, course) {\n                        data['course'].push(course.id);\n                    });\n                } else {\n                    $.grep(courses, function(course) {\n                        if ($.inArray(course.category, allCategories) === -1) {\n                            data['course'].push(course.id);\n                        }\n                    });\n                }\n\n                $.ajax({\n                    type: \"POST\",\n                    url: '/local/notificationsagent/assignrule.php',\n                    data: {\n                        ruleid: idtemplate,\n                        category: data['category'],\n                        course: data['course'],\n                    },\n                    success: function() {\n                        window.location.reload();  \n                    },\n                    error: function(XMLHttpRequest, textStatus, errorThrown) { \n                        console.log(\"Status: \" + textStatus); \n                        console.log(errorThrown); \n                    },\n                    dataType: 'json'\n                });\n                   \n            });\n        },\n        loopatfirstparent: function(idparent, arrayParents = []){\n            var module = this;\n            \n            if(idparent != '#category-listing-content-0'){\n                arrayParents.push(idparent.replace('#category-listing-content-', ''));\n                var dataparent = $('#assignTemplateModal .category-listing #listitem-category-'+idparent.replace('#category-listing-content-', '')+' > .category-listing-header .custom-control-input').attr('data-parent');\n                return module.loopatfirstparent(dataparent, arrayParents);\n            }else{\n                return arrayParents;\n            }\n        }\n    };\n});\n"],"names":["define","init","idtemplate","$","on","event","button","relatedTarget","data","modal","this","find","text","attr","ajax","type","url","ruleid","success","forEach","categoryid","category","length","prop","courseid","course","error","XMLHttpRequest","textStatus","errorThrown","console","log","dataType","parents","removeClass","addClass","checkssubcategoriescourses","replace","allCategories","has","each","items","id","map","parent","inArray","push","get","item","grep","courses","isEmptyObject","index","window","location","reload","loopatfirstparent","idparent","arrayParents","module","dataparent"],"mappings":"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"}